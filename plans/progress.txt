2026-02-20 — Database schema models added

Added ScheduleEntry, FoodEntry, AiAnalysis models to prisma/schema.prisma.
All three reference User.id as a FK. FoodEntry has @@unique([userId, date, mealType]).
AiAnalysis has @unique on userId (one record per user). All models have @@index([userId]).
Migration 20260220144005_add_schedule_food_ai_models applied successfully to Postgres.

2026-02-20 — Env variable validation added

Updated src/env.js: server validates CLERK_SECRET_KEY, OPENAI_API_KEY, DATABASE_URL;
client validates NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY and all NEXT_PUBLIC_CLERK_*_URL vars.
Updated .env.example with all required variable names and placeholder values.

2026-02-21 — shadcn/ui initialized and components installed

Ran `npx shadcn@latest init --defaults` — detected Tailwind v4, created components.json,
updated globals.css with CSS variables, created src/lib/utils.ts.
Installed: accordion, button, card, sonner, input, textarea, carousel.
embla-carousel-react@^8.6.0 added to package.json as a dependency.

2026-02-21 — Vercel AI SDK installed

ai 6.0.94 + @ai-sdk/openai 3.0.30 pinned in package.json. Provider: openai('gpt-4.1').
OPENAI_API_KEY already validated in env.js.

2026-02-21 — Root layout + desktop max-width

layout.tsx: viewport export, Geist variable on html, font-sans + bg-background on body,
max-w-sm mx-auto wrapper (pb-16 for tab bar), Toaster (bottom-center), title "Life Helper".
ThemeProvider (next-themes, defaultTheme="system", enableSystem) — dark/light follows OS.
suppressHydrationWarning on <html>. afterSignOutUrl="/sign-in" moved to ClerkProvider.

2026-02-21 — Tab bar + navigation + settings

src/components/layout/tab-bar.tsx: fixed bottom nav, max-w-sm centered, 4 items.
- Schedule (CalendarDays → /), Food Diary (BookOpen → /food-diary),
  AI Overview (Sparkles → /ai-overview), Settings (Clerk UserButton inline).
- usePathname() drives active state: text-primary + font-semibold + strokeWidth 2.5.
- Inactive tabs: text-muted-foreground + strokeWidth 1.75.
- UserButton opens Clerk modal in-place; URL does not change.
Stub pages created: /food-diary and /ai-overview.

Next priority (PLANS.json): auth-clerk-webhook (unblocks all server actions),
then schedule-server-actions.

2026-02-21 — Auth infrastructure (auth-clerk-webhook + auth-redirect + auth-userid-access)

src/app/api/webhooks/clerk/route.ts: verifies Svix signature via verifyWebhook from
@clerk/nextjs/webhooks. user.created/user.updated → prisma.user.upsert (id, email, name).
user.deleted → prisma.user.deleteMany. Returns 204 on success, 400 on invalid signature.
src/env.js: CLERK_WEBHOOK_SECRET added to server schema. AI_GATEWAY_API_KEY replaces
OPENAI_API_KEY (user is routing through an AI gateway).
src/middleware.ts: /api/webhooks/clerk added to public routes. All other routes protected
via auth.protect(). clerkMiddleware from @clerk/nextjs/server.
src/lib/auth.ts: getRequiredUserId() — calls auth(), throws "Unauthorized" if userId null.
All server actions must use this helper instead of calling auth() directly.

Next priority: schedule-server-actions (now unblocked — auth-userid-access complete).

2026-02-21 — Schedule server actions

Created src/server/actions/schedule.ts with three 'use server' actions:
- createScheduleEntry(weekday, startTime, endTime, activity): inserts row, revalidatePath('/').
- getScheduleEntries(): findMany filtered by userId, ordered by startTime asc.
- deleteScheduleEntry(id): verifies ownership via findFirst, deletes, revalidatePath('/').
All mutations return { success: true } | { success: false; error: string }.
pnpm check + tsc --noEmit both pass.

Next priority: schedule-page (now unblocked — schedule-server-actions + layout-tabbar complete).

2026-02-21 — Schedule page (week carousel + day slide + activity row)

src/app/page.tsx: server component calls getScheduleEntries(), passes entries to WeekCarousel.
src/components/schedule/week-carousel.tsx: 'use client'; useEmblaCarousel({ loop: true,
  startIndex: (getDay()+6)%7 }). Groups entries by weekday (Mon=0…Sun=6). 7 slides.
src/components/schedule/day-slide.tsx: h-[calc(100dvh-4rem)], day name header, scrollable
  activity list with pb-20 gap for future sticky form, 'No activities yet' empty state.
src/components/schedule/activity-row.tsx: '{startTime} – {endTime} · {activity}' layout.
pnpm check + tsc --noEmit pass.

Next priority: schedule-form (AddActivityForm sticky at bottom of each DaySlide).

2026-02-21 — Schedule form (AddActivityForm)

src/components/schedule/add-activity-form.tsx: 'use client'; two time inputs (type=time) +
  text input + Add button. Submit disabled until all fields filled. Calls createScheduleEntry
  server action. On success: clears all fields, toast.success("Activity added"). On error:
  inline <p className="text-destructive"> below form. sticky bottom-0 border-t bg-background.
src/components/schedule/day-slide.tsx: added weekday: number prop, removed pb-20 placeholder,
  mounts <AddActivityForm weekday={weekday} /> as last flex child.
src/components/schedule/week-carousel.tsx: passes weekday={i} to each DaySlide.
pnpm check + tsc --noEmit pass.

Next priority: schedule-interactions (long-press delete + optimistic UI + overlap warning).

2026-02-21 — Schedule interactions (long-press delete + optimistic UI + overlap warning)

ActivityRow: 'use client'; 500ms onPointerDown timer → showDelete overlay. onPointerUp/Leave
  cancels timer. Document click listener (capture phase) dismisses overlay on tap elsewhere.
  Delete button triggers onDelete(id) prop, stopPropagation to prevent self-dismiss.
DaySlide: 'use client'; useOptimistic<Entry[], add|delete action> + useTransition. handleAdd
  wraps startTransition(async) + dispatch({ type:'add' }) + createScheduleEntry in a Promise
  so AddActivityForm can await result. handleDelete dispatches { type:'delete' } then calls
  deleteScheduleEntry; error shown via toast.error.
AddActivityForm: removed direct server action import + weekday prop. Now receives entries[]
  (for overlap) + onAdd callback. Overlap: findOverlap computes timeToMinutes, checks all
  entries for the slide; shows yellow warning inline but does not block submit. Clears
  overlapWarning on successful save. pnpm check passes.

Next priority: fooddiary-server-actions (unblocked — auth-userid-access complete).

2026-02-21 — Food diary server actions

Created src/server/actions/food-diary.ts with three 'use server' actions:
- getTodayFoodEntries(): findMany filtered by userId + date range [todayUTC, todayUTC+24h).
- createFoodEntry(mealType, description): inserts row with feelings=null, date=todayUTC(), revalidatePath('/food-diary').
- updateFoodEntryFeelings(id, feelings): verifies ownership via findFirst, updates feelings, revalidatePath('/food-diary').
todayUTC() helper: Date.UTC(year, month, day) — normalises to midnight UTC to match stored dates and respect @@unique([userId, date, mealType]).
pnpm check passes.

Next priority: fooddiary-page (unblocked — fooddiary-server-actions + layout-tabbar complete).

2026-02-21 — Food diary page (fooddiary-page)

src/app/food-diary/page.tsx: server component; calls getTodayFoodEntries(), formats today's
  date via toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' }),
  renders shadcn Accordion (type="multiple") with one MealAccordion per meal type.
src/components/food-diary/meal-accordion.tsx: 3-state logic — no entry → FoodEntryForm;
  entry.feelings===null → read-only description + FeelingsForm; both set → both read-only.
  No edit/delete buttons at any state.
src/components/food-diary/food-entry-form.tsx: 'use client'; textarea + Save; calls
  createFoodEntry; toast.success on success; inline text-destructive error on failure.
src/components/food-diary/feelings-form.tsx: 'use client'; textarea + Save; calls
  updateFoodEntryFeelings; toast.success on success; inline error on failure.
feedback-toast-and-errors also marked complete: all forms (schedule + food diary) already
  implement toast.success on success and inline p.text-destructive on error.

Next priority: ai-server-route (unblocked — setup-ai-sdk + auth-userid-access complete).

2026-02-21 — AI server route (ai-server-route)

src/lib/ai.ts: createOpenAI provider instance using AI_GATEWAY_API_KEY.
src/app/api/ai/analyze/route.ts: POST handler.
- Validates auth via getRequiredUserId() → 401 on failure.
- Validates body with zod { mode: 'full'|'incremental' } → 400 on failure.
- Full mode: queries all FoodEntry for user.
- Incremental mode: fetches existing AiAnalysis, queries FoodEntry where date > lastEntryDate;
  if no existing analysis, falls back to full query.
- Builds formatted entries text (date, mealType, description, feelings).
- Incremental prompt prepends previous analysis JSON; instructs AI to update it.
- generateObject with gpt-4.1, nutrition/wellness analyst system prompt, analysisSchema
  (recommended/notRecommended: {dish,reason}[]; avoidProducts: {product,reason}[]).
- Upserts AiAnalysis row with result + lastEntryDate = newest entry date.
- Returns 200 { success: true }.
tsc --noEmit passes.

Next priority: ai-overview-page (unblocked — ai-server-route + layout-tabbar complete).

2026-02-21 — AI Overview page (ai-overview-page)

src/app/ai-overview/page.tsx: server component; calls auth() + prisma parallel queries for
  AiAnalysis and FoodEntry count. Empty state: explanation text + AnalysisActions (Generate
  button, disabled if count < 14 with 'X/14 meals logged' message). Analysis state: 'Last
  updated: [timestamp]', three AnalysisCards (Recommended Dishes / Strictly Not Recommended /
  Products/Ingredients to Avoid), then AnalysisActions (Update + Regenerate buttons).
src/components/ai/analysis-card.tsx: Card with title + items list ({ name, reason }[]).
  Shows 'No items.' when array is empty.
src/components/ai/analysis-actions.tsx: 'use client'; loading state disables all buttons
  (fire-and-forget). Empty state: single Generate button (disabled < 14 entries + progress
  msg). Analysis state: Update (mode=incremental) + Regenerate (mode=full). Toast on trigger.
JSON fields (recommended, notRecommended, avoidProducts) cast from Prisma.JsonValue.

Next priority: pwa-manifest (no remaining dependencies).

2026-02-21 — PWA manifest (pwa-manifest)

src/app/manifest.ts: Next.js file convention; auto-links <link rel="manifest"> in all pages.
  name/short_name='Life Helper', display='standalone', orientation='portrait',
  background_color/theme_color='#ffffff'. Icons: /icons/icon-192.png (192x192),
  /icons/icon-512.png (512x512, purpose='any'), /icons/icon-512.png (purpose='maskable').
public/icons/icon-192.png + icon-512.png: generated via scripts/gen-icons.mjs (Node.js built-ins
  only — zlib deflate + hand-rolled CRC32 PNG encoder). Indigo (#4f46e5) rounded-rect background
  with white "R" letter. Valid PNG confirmed by `file` command.
Also fixed three pre-existing lint errors in earlier files:
  - ai-overview/page.tsx: escaped apostrophe in JSX text (react/no-unescaped-entities)
  - api/ai/analyze/route.ts: `let entries` → `const entries`
  - api/ai/analyze/route.ts: refactored IIFE to return { entries, previousAnalysis } tuple
    instead of mutating an outer variable (fixes @typescript-eslint/restrict-template-expressions
    false-positive caused by TypeScript refusing to narrow closure-mutated `let` vars).
pnpm check passes.

Next priority: pwa-service-worker (now unblocked — pwa-manifest complete).
After that: ui-polish (spacing review — only remaining failing PRD item).

2026-02-21 — PWA service worker (pwa-service-worker)

public/sw.js: hand-rolled service worker (no extra dependency — avoids next-pwa/Serwist
  webpack requirement conflicts with Turbopack).
  - install: skipWaiting() for instant activation.
  - activate: purges stale caches, claims clients.
  - fetch: skips non-GET, /api/*, /sign-in, /sign-up.
    /_next/static/* → cache-first (content-hashed, safe to cache forever).
    HTML pages → network-first with cache fallback for offline resilience.
src/components/pwa-register.tsx: 'use client'; useEffect registers /sw.js via
  navigator.serviceWorker.register on mount.
src/app/layout.tsx: <PwaRegister /> mounted inside ThemeProvider.
next.config.js: headers() adds Cache-Control: no-cache + Content-Type for /sw.js
  so browsers always fetch the latest service worker version.
tsconfig.json: added "public" to exclude array — service worker runs in
  ServiceWorkerGlobalScope (not Window/DOM), so ts-checking it against dom lib
  produced false-positive errors.
pnpm check passes.

Next priority: ui-polish (only remaining failing PRD item).

2026-02-21 — UI polish (ui-polish)

src/components/food-diary/meal-accordion.tsx: removed px-1 micro-padding from
  accordion content inner div. AccordionContent has no built-in horizontal padding;
  px-1 added a misaligned 4px inset vs trigger. Page wrapper p-4 already provides
  16px horizontal padding — content now aligns with trigger edge.
All other spacing criteria already passing: Food Diary + AI Overview both use
  p-4 pb-20, date header has mb-4, space-y-4 between sections.
pnpm check passes.

All PRD items now pass. Project complete.
